\subsubsection{}
\label{sec:development:arch:pp:communication}

Как уже отмечалось выше, двумя основными способами связи клиента с свервером будут выступать \gls{ws} и \textit{REST} \gls{api}. При проектировании форматов запроса и ответа преследовалась цель создать универсальный формат на оба способа коммуникации, что позволит переиспользовать код парсинга данных и формирования запросов.

Все данные передаются в формате \textit{JSON}, формат запроса через \textit{REST} зависит от конкретного запроса, для событий, отправляемых клиентом через \gls{ws} был принят формат, отражённый в листинге \ref{sec:development:arch:pp:communication:code:ws:request}, где поле \texttt{type} принимает строковое значение, которое равно одному из названий возможных событий (отправка сообщения, подтверждение получения события и так далее).

\begin{code}
	\inputminted{json}{inc/src/client_ws_req_format.json}
   \caption{Шаблон клиентских запросов через WebSocket}
   \label{sec:development:arch:pp:communication:code:ws:request}
\end{code}

Формат ответа сервера на \textit{REST} запросы зависит от конкретного запроса, а формат посылаемых сообщений в \gls{ws} приведён в листинге \ref{sec:development:arch:pp:communication:code:ws:response}, где \texttt{type} может принимать одно из следующих значений: 

\begin{enumerate}
	\item \textit{success} -- отправленный клиентом запрос был успешно обработан. При отправке сообщения такого типа, сервер должен добавить поле \texttt{request_id} в тело запроса, что б клиент мог понять, какой именно запрос был успешно обработан.
	\item \textit{error} -- отправленный клиентом запрос не был обработан успешно. При отправке сообщения такого типа, сервер сформировать значение поля \texttt{data} таким образом, что в нём будет находится вся необходимая для успешной десирализации ошибки информация. Минимальным требованием для выполнения этого условия является наличие поля \texttt{error_code}.
	\item \textit{event} -- данный тип сообщений присылается по инициативе сервера и используется для уведомления клиента о возникновении какого-либо события (например, пришло новое сообщение). Формат поля \texttt{data} в этом случае зависит от значения поля \texttt{event_type}.
\end{enumerate}

\begin{code}
	\inputminted{json}{inc/src/server_ws_format.json}
   \caption{Шаблон серверных событий, отправленных через WebSocket}
   \label{sec:development:arch:pp:communication:code:ws:response}
\end{code}

Общение через \gls{ws} отличается от отправки запросов, так как в стандарте \gls{ws} не предусмотрено статус кодов запроса, заголовков. Отсутствие заголовков ограничивает возможности кеширования запросов, отсутствие которого стало большой проблемой при разработке ПП. В связи с этим, был разработан набор правил, по которым клиент отправляет и получает запросы через \gls{ws}:

\begin{itemize}
	\item при отправе запроса, клиент должен добавлять к нему номер запроса: число, которое увеличивается с каждым запросом;
	\item запрос считается отправленным только после успешного получения от сервера сообщения с кодом запроса;
	\item в клиенте должен быть реализован механизм досылки запросов, на которые клиент не получил ответа от сервера;
	\item на сервере должен быть реализован механизм фильтрации запросов, которые уже были обработаны;
	\item при отправке сообщений типа \textit{event}, сервер должен добавлять номер события: число, которое увеличивается с каждым событием;
	\item событие считается доставленным, когда клиент отправит сообщения подтверждения с соответствующим номером события;
	\item событие должно присылаться клиенту до тех пор, пока клиент не ответит событием об успешной обработке;
	\item события могут удалять друг друга, если это удовлетворяет бизнес-логике, например, события входа-выхода из состояния онлайн должны заменять друг друга, что б клиент не получал всю историю неактуальных событий.
\end{itemize}

Клиент сохраняет все отправляемые запросы во временное хранилище, которое позволяет ему позже узнать какие запросы нужно отправить ещё раз. Для поддержки постоянного соединения, клиент должен отвечать на события \gls{ws} типа \texttt{ping}. Все \textit{REST} запросы должны отправляться с заголовком авторизации, содержащий токен авторизации, \gls{ws} соединение открывается запросом, который также содержит заголовок авторизации.